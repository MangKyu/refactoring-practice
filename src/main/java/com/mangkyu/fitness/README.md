# Fitness Refactoring
해당 프로젝트는 인텔레지에의 단축키를 연습하기 위한 프로젝트입니다.
해당 프로젝트는 기본적으로 백명석님의 유튜브 [클린코더스](https://www.youtube.com/playlist?list=PLeQ0NTYUDTmMM71Jn1scbEYdLFHz5ZqFA)를 참고하여 작성되었습니다.

## 기존 코드의 문제점 찾기
- 거대한 함수 문제
  - printReport 함수가 지나치게 거대함
  - amount / 100.0이 여러 곳에 퍼져있어서 응집도가 떨어짐
  - total, mealExpenses 변수들이 필드로 존재하지 않아 응집도가 떨어짐
- 함수 단위의 SRP 위반
  - SRP는 변경의 이유가 하나여야 한다는 의미임
  - 하지만 printReport는 계산과 출력을 모두 담당하고 있으므로, 계산이 변경되어야 하는 경우 또는 출력을 변경해야 하는 경우에 변경이 필요함
- OCP 위반
  - 새로운 타입이 추가되면 코드 변경이 필요함
  - 타입과 타입에 따른 처리는 추상화되어야 함

## 리팩토링 시작 전에
- 커버리지와 함께 실행하는 단축키 설정
- 테스트 커버리지를 통해 모든 코드의 변경이 보호되고 있음을 확인하기

## 리팩토링 진행하기
1. 계산 로직과 출력 로직 분류하기
   - 문제점
     1. 하나의 반복문 안에 계산 로직과 출력 로직이 결합되어 있음 
   - 리팩터링
     1. Option + 위로 반복문을 선택하고 복사함(Command + D)
     2. 처음 반복문에서는 계산 로직만을 남기고, 두 번째 반복문에서는 출력 로직만을 남김(Command + X)
   - 결과
     1. 2개의 반복문이 생성되고, 각각 출력과 계산의 용도로 사용됨
     2. 성능적인 관점에서의 trade-off가 될 수 있지만, 대부분의 경우 가독성이 중요함
2. 자주 사용되는 변수를 필드로 추출하기
   - 문제점
     1. total, mealExpenses 변수는 메서드 전반에 걸쳐서 사용되고 있음
     2. 해당 변수들을 클래스 필드로 옮기면 메서드의 응집도를 높일 수 있음
     3. 또한 클래스 필드로 추출하여 메서드로 넘겨지는 파라미터의 수를 줄일 수 있음
   - 리팩터링
     1. total, mealExpenses 변수를 클래스 변수로 뽑아냄(Command + Option + F)
   - 결과
     1. total, mealExpenses 변수가 클래스 변수로 선언됨
3. 메서드를 추출하여 가독성 높이기 1차
   - 문제점
     1. expense의 type에 따라 값을 더하는 로직은 의미를 찾기 어려움
     2. 메서드들은 적당한 수준으로 추상화되지 않아서 어떠한 로직이 진행되는지 알기 어려움
     3. 메서드를 추출하여 전반적인 로직의 가독성을 높일 수 있음 
   - 리팩터링
     1. 계산하는 반복문 내의 메서드들을 추출함(Command + Option + M)
     2. static으로 선언되는 메서드들의 static 키워드들을 제거함
   - 결과
     1. 계산하는 로직들이 메서드로 추출됨
4. 메서드를 추출하여 가독성 높이기 위한 사전 준비
   - 문제점
     1. 값을 100으로 나누는 부분은 달러로 환산하는 부분임
     2. 해당 부분을 하나의 메서드로 추출할 필요가 있음
   - 리팩터링
     1. expense.amount / 100 하는 부분에서 expense.amount를 변수로 추출함(Command + Option + V)
     2. 변수 / 100 하는 부분을 메서드로 추출함(Command + Option + M)
     3. 리팩터링을 위해 추출했던 변수를 인라인 처리함(Command + Option + N)
   - 결과
      1. 출력하는 로직들이 메서드로 추출됨
5. 메서드를 추출하여 가독성 높이기 2차
   - 문제점
     1. 출력을 담당하는 로직이 하나로 응집되어 있지 않음
     2. 메서드들은 적당한 수준으로 추상화되지 않아서 어떠한 로직이 진행되는지 알기 어려움
     3. 메서드를 추출하여 전반적인 로직의 가독성을 높일 수 있음
   - 리팩터링
     1. 출력하는 메서드들을 가독성 좋게 추출함(Command + Option + M)
     2. static으로 선언되는 메서드들의 static 키워드들을 제거함
   - 결과
     1. 출력하는 로직들이 메서드로 추출됨
6. 계산을 담당하는 클래스를 분리함
   - 문제점
     1. 하나의 클래스에 계산 로직과 출력 로직이 결합되어 있음
     2. 현재의 클래스는 ExpenseReport(보고서)로 계산을 담당하는 클래스로 계산 로직을 위임해야 함(ExpenseReporter)
   - 리팩터링
     1. ExpenseReport 클래스 위에서 Control + T 클릭
     2. Extract Delegate 선택
     3. 계산을 담당하는 메서드와 변수를 선택하고 위임함
   - 결과
     1. 계산을 담당하는 클래스가 파생됨

![](./extract_delegate.png)


7. 리팩터링 부수 효과 정리하기
   - 문제점
     1. 계산을 담당하는 새로운 클래스를 생성하면서, 미사용되는 메서드들이 남아 있음
     2. 파생된 클래스에서 적절한 import가 되지 않아서 컴파일 에러가 발생함
   - 리팩터링
     1. 출력을 담당하는 클래스에서 F2로 미사용 메서드들로 이동하고, Option + Enter를 눌러서 미사용 메서드들을 safe-delete 해줌
     2. 계산을 담당하는 클래스에서 F2로 컴파일 에러가 발생하는 라인으로 이동하고, Option + Enter를 눌러서 import 해줌
   - 결과
     1. 미사용 메서드들이 정리됨
     2. 컴파일 에러가 해결됨
8. Expense에 있어야 하는 기능들을 이동시키기
   - 문제점
     1. 도메인의 응집도를 높일 수 있도록 해당 도메인에 종속적인 기능들을 이동시켜야 함
   - 리팩터링
     1. 출력용 클래스에서 ExpenseName을 가져오는 메서드를 Expense로 이동시킴(F6)
   - 결과
     1. Expense 클래스에 종속적인 기능들이 해당 메서드 안으로 이동됨
9. 타입으로 분기되는 부분을 제거하여 OCP를 달성함
   - 문제점
     1. Expense 클래스 내부에서 type에 따라 메서드들이 분기되고 있음
     2. 이러한 구현은 OCP를 위반하므로, 상속과 다형성으로 문제를 해결할 수 있음
   - 리팩터링
     1. Expense 클래스를 abstract로 선언함
     2. 테스트 코드에서 컴파일 에러가 발생하는 부분으로 이동함(F2)
     3. new Expense(DINNER, 1000)와 같이 생성되는 부분을 new DinnerExpense(DINNER, 1000)로 변경함(Dinner, Breakfast, CarRental 전체)
     4. 컴파일 에러가 발생할텐데, Option + Enter를 누르고 create class로 클래스를 생성함
   - 결과
     1. 다형성을 위한 DinnerExpense, BreakfastExpense, CarRentalExpense 클래스가 탄생함
10. 클래스와 타입이 중복되는 부분을 제거함
    - 문제점
      1. DinnerExpense는 이름 그 자체로 Dinner를 표현함
      2. 문제는 객체 생성 시에 new DinnerExpense(DINNER, 1000)로 DINNER 타입을 다시 전달하고 있음
      3. 따라서 객체 생성 시에 타입이 전달되는 부분을 인라인 처리함
    - 리팩터링
      1. 각각의 구현체로 이동하고, type 필드에 대고 인라인 처리함(Command + Option + N)
    - 결과
      1. 타입이 전달되는 부분이 객체의 생성자 부분으로 제한됨
11. 추상 클래스에 타입으로 분기되는 부분을 제거함
    - 문제점
      1. Expense 클래스에 여전히 타입으로 분기하는 부분들이 남아있음
      2. 해당 부분들을 자식 클래스로 내려서 다형성으로 분기되는 부분을 제거함
    - 리팩터링
      1. Expense 클래스에서 타입으로 분기되는 메서드들에 Control + T를 클릭
      2. Push down members를 선택하고, keep abstract를 체크한 후에 변경함
      3. 각 하위 클래스에 존재하는 메서드들에서 불필요한 분기를 제거함
    - 결과
      1. 타입으로 분기되는 부분들이 제거되고, OCP를 준수하도록 변경됨
12. 리팩토링 결과를 정리함
    - 문제점
      1. 불필요한 import들이 남아있으므로 정리가 필요함
      2. 하위 클래스들이 test 패키지에 생성되어 있음
    - 리팩터링
      1. project explorer로 커서를 이동함(Command + 1)
      2. 상위 패키지로 이동하여 불필요한 import를 제거함(Control + Option + O)
      3. Expense 하위 클래스들을 복수 선택(Shift + 아래)하고 패키지 이동함(F6)
    - 결과
      1. 리팩터링이 마무리 됨 